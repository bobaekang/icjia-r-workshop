---
title: "R Workshop: Module 3 (1)"
author: "Bobae Kang"
date: "March 28, 2018"
output:
  html_document:
    self_contained: false
    lib_dir: ./notes_files
    toc: TRUE
    toc_float	:	TRUE
    toc_depth: 2
    includes:
      after_body: ../include_footer.html
css: ../css/style.css
---
<!-- fontawesome CDN -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<!-- logo -->
<div class="logo">
  <a href="http://www.icjia.state.il.us/"><img src="../images/icjia.png" alt="ICJIA logo"></img></a>
</div>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyr)
library(icjiar)
```

This page contains the notes for **the first part of R Workshop Module 3: Data Analysis with R**, which is part of the R Workshop series prepared by ICJIA Research Analyst [Bobae Kang](http://www.icjia.state.il.us/biographies/bobae-kang) to enable and encourage ICJIA researchers to take advantage of R, a statistical programming language that is one of the most powerful modern research tools.

### Links
Click [**here**](../index.html) to go to the workshop **home page**.

Click [**here**](../modules.html) to go to the workshop **Modules page**.

Click [**here**](../slides/module3_slides1.html) to view the accompanying **slides for Module 3, Part 1**.

Navigate to the other workshop materials:

<button class="btn" data-toggle="collapse" data-target="#collapse-navigate" aria-expanded="false" aria-controls="collapse-navigate">**SEE MORE**</button>

<div class="collapse mt-1" id="collapse-navigate">
<div style="padding:20px;">

* **Module 1: Introduction to R** ([**slides**](../slides/module1_slides.html),
[**note**](module1_notes.html))
* **Module 2: R basics**
    * Part 1 ([**slides**](../slides/module2_slides1.html), [**note**](module2_notes1.html))
    * Part 2 ([**slides**](../slides/module2_slides2.html), [**note**](module2_notes2.html))
* **Module 3: Data analysis with R**
    * Part 2 ([**slides**](../slides/module3_slides2.html), [**note**](module3_notes2.html))
* **Module 4: Data visualization with R**
    * Part 1 ([**slides**](../slides/module4_slides1.html), [**note**](module4_notes1.html))
    * Part 2 ([**slides**](../slides/module4_slides2.html), [**note**](module4_notes2.html))
* **Module 5: Statistical modeling with R**
    * Part 1 ([**slides**](../slides/module5_slides1.html), [**note**](module5_notes1.html))
    * Part 2 ([**slides**](../slides/module5_slides2.html), [**note**](module5_notes2.html))
* **Module 6: "To Infinity and Beyond"**
    * Part 1 ([**slides**](../slides/module6_slides1.html), [**note**](module6_notes1.html))
    * Part 2 ([**slides**](../slides/module6_slides2.html), [**note**](module6_notes2.html))

</div>
</div>


***


# Data Analysis with R (1): Getting started with `tidyverse`

```{r echo=FALSE, out.width="20%", out.extra='style="box-shadow: none; margin-left: 20%"'}
images <- c("https://d33wubrfki0l68.cloudfront.net/071952491ec4a6a532a3f70ecfa2507af4d341f9/c167c/images/hex-dplyr.png", "https://d33wubrfki0l68.cloudfront.net/5f8c22ec53a1ac61684f3e8d59c623d09227d6b9/b15de/images/hex-tidyr.png")
knitr::include_graphics(images)
```
<div style="font-size:0.5em; text-align:center; color: #777;">
Source: <a href="https://www.tidyverse.org/">tidyverse.org</a>
</div>


***


# Getting Ready

## Installing the packages

* Installing all `tidyverse` packages can be easily done with the follwoing command:

```{r eval=FALSE}
# Install from CRAN
install.packages("tidyverse")

# Or the development version from GitHub
# install.packages("devtools")
devtools::install_github("hadley/tidyverse")
```

* Installing `tidyverse` package installs the following:
    * core tidyverse packages
        * `ggplot2`, `dplyr`, `tidyr`, `readr`, `purrr`, `tibble`
    * packages to work with specific vector types 
        * `hms`, `stringr`, `lubridate`, `forcats`
    * packages to import data
        * `feather`, `haven`, `httr`, `jsonlite`, `readxl`, `rvest`, `xml2`
    * packages to facilitate statistical modeling
        * `modelr`, `broom`

* Of course, each pacakge can be installed separately:

```{r eval=FALSE}
# Install ggplot2
install.packages("ggplot2")

# Install both dplyr and tidyr with a single commend
#   with a character vector of the package names 
install.packages(c("dplyr", "tidyr"))
```


## Importing the packages

* Once installed, we can now import the packages using `library()`:

```{r eval=FALSE}
# This imports the core tidyverse packages
library(tidyverse)

# Or import packages separately
library(dplyr)
library(tidyr)
```


***


# Manipulating Your Data

```{r echo=FALSE, out.width="25%", out.extra='style="box-shadow: none; display: block; margin: auto;"'}
knitr::include_graphics(images[1])
```
<div style="font-size:0.5em; text-align:center; color: #777;">
Source: <a href="https://www.tidyverse.org/">tidyverse.org</a>
</div>


## Key dplyr functions

* `arange()`
* `select()` `rename()`
* `filter()`
* `mutate()` `transmute()`
* `left_join()`
* `summarise()`
* `group_by()` `ungroup()`
* `%>%`, the pipe operator


## Sort rows by variables

```{r eval=FALSE}
arrange(tbl, ...)
```
* The first argument is a tabular data object
    * e.g. `data.frame` or `tibble`
* Columns by which to sort the data as other arguments
    * Multiple columns can be used to sort the data
    * When multiple columns are given, sorting is done hierarchically
    * Sorting in a descending order with `desc()`

    
### Example
```{r eval=FALSE}
# without using pipe
head(arrange(ispcrime, county))

# with using pipe
ispcrime %>%
  arrange(county) %>%
  head()
```
```{r echo=FALSE}
ispcrime %>%
  arrange(county) %>%
  head()
```

```{r}
# sort by county and year, in a DESCENDING order
ispcrime %>%
  arrange(desc(county)) %>%
  head() 
```


## Filter rows with conditions

```{r eval=FALSE}
filter(tbl, ...)
```
* The first argument is a tabular data object
* The following arguments are conditional expressions
    * Only the rows satisfying the given conditions are kept


### Example
```{r}
ispcrime %>%
  filter(
    year == 2015,
    murder > 0
  ) %>%
  head()
```


## Select and/or rename variables
```{r eval=FALSE}
select(tbl, ...)
rename(tbl, ...)
```
* The first argument is a tabular data object 
* The following argumetns are columns to select/rename
    * `select()` returns the selected columns only while `rename()` keeps all columns
    * Renaming each selected column is also possible with `select()`
* `select()` can be also used to exclude a section of columns using a minus (`-`) sign while keeping the rest.
    
    
### Example
```{r}
# select with renaming columns
ispcrime %>%
  select(year, county, v_crime = violentCrime, p_crime = propertyCrime) %>%
  head()
```

```{r}
# excluding columns
ispcrime %>%
  select(-violentCrime, -propertyCrime) %>%
  head()
```


## Transform and add variables
```{r eval=FALSE}
transmute(tbl, ...)
mutate(tbl, ...)
```
* The first argument is a tabular data object 
* The following arguments transform or add columns
    * An exisiting column is modified with an expression with the same column name
    * A new column is created with an expression having a new column name
    * `transmute()` returns the transformed/added columns only while `mutate()` keeps all columns
    
    
### Example
```{r}
ispcrime %>%
  mutate(totalCrime = violentCrime + propertyCrime) %>%
  head()
```


## Merge tables
```{r eval=FALSE}
left_join(tbl1, tbl2, by = NULL, ...)
```
* The first two arguments are tabular data objects to join 
* `by` takes a chracter vector containing a selection of variables to join tables by
    * By default, all columns with common names are used
* Other types of join: `inner_join()`, `right_join()`, `semi_join()`, `anti_join()`, `full_join()`


### Example
```{r}
ispcrime %>%
  left_join(regions, by = "county") %>%
  head()
```


## Aggregate and summarise rows
```{r eval=FALSE}
summarise(tbl, ...)
summarize(tbl, ...)
```
* The first argument is a tabular data object
* The following arguments are expressions to summarise data
    * `summarise()` and `summarize()` are identical
    * each summary column resulting from each summarizing expression can be given a name



### Example
```{r}
ispcrime %>%
  summarise(
    violentCrimeAverage = mean(violentCrime, na.rm = TRUE),
    propertyCrimeAverage = mean(propertyCrime, na.rm = TRUE)
  )
```


## Group by variables
```{r eval=FALSE}
group_by(tbl, ...)
ungroup(tbl, ...)
```
* The first argument is a tabular data object
* The following arguments are columns by which to group the data
  * `group_by()` and `ungroup()` are the opposite operations
* `group_by()` can be used in combination with other function to allow for group-specific data manipulations


### Example
```{r}
ispcrime %>%
  group_by(year)
```


```{r}
ispcrime %>%
  group_by(year) %>%
  summarise(
    violentCrimeAverage = mean(violentCrime, na.rm = TRUE),
    propertyCrimeAverage = mean(propertyCrime, na.rm = TRUE)
  )
```


## Chain operations

We have been using the pipe operator, `%>%`, in our code examples. Now is a good time to take a closer look at it.

```{r eval=FALSE}
data %>% function1(arg2, ...) %>% ...
```

`%>%` is a binary operator that requires two objects for it to work on. Think of `+` as another example of a binary operator. In the case of `%>%` the object preciding the operator has to be the first argument for the function that follows the oprator. In other words, the preceding object is injected into the following function as its first argument. The result of the `%>%` operator is the output of the function.

In fact, as we have already seen before, multiple functions can be chained, or "piped," using `%>%` as long as the output of the first "piping" generates a suitable object for the first argument of the next function to be chained.

with piping, we can have a coding style that is cleaner and more intuitive--that reflects the way we think about how we apply the operations to the object, rather than the tranditional syntax where the function that acts on the last comes at the beginning of the statement:

```{r eval=FALSE}
# piping style
object %>%
  function1(arguments1) %>%
  function2(arguments2) %>%
  function3(arguments3)


# traditional style
function3(
  function2(
    function1(
      object,
      arguments1
    ),
    arguments2
  ),
  arguments3  
  
)

# or
function3(function2(function1(object, arguments1), arguments2), arguments3)
```


## `dplyr` in action

Let's take a look at more concrete examples of using `dplyr` functions to work on data manipulation and analysis. For those of you who were there at my presentation for the February R&A meeting, these are the some of the examples used in that presentation--now we can understand them better!

### Example 1

```{r}
ispcrime %>%
  filter(substr(county, 1, 1) == "D", year %in% c(2014, 2015)) %>%
  mutate(totalCrime = violentCrime + propertyCrime) %>%
  select(year, county, totalCrime)
```

In this example, we we want to answer the following question: What are the total crime count in 2014 and 2015 for counties whose name starts with letter D?

1. We start with `ispcrime` data
2. We use the pipe operator to feed the `ispcrime` data into `filter()`
    * we have two filtering conditions. First condition is that the first letter of the `county` column value matches "D" (`substr(county, 1, 1) == "D"`)
    * Second condition is that the `year` column value has to be either 2014 or 2015 (`year %in% c(2014, 2015)`)
3. We use the pipe operator to feed the filtered data into `mutate()`
    * Here we create a new column named `totalCrime`, which is the sume of `violentCrime` and `propertyCrime` values
4. Finally, we use the filtered *and* mutated data into `select()`
    * The final output will include `year`, `county`, and `totalCrime` columns only.


### Example 2
```{r message=FALSE}
ispcrime %>%
  left_join(regions) %>%
  group_by(region, county) %>%
  summarise(annualAvgCrime = sum(violentCrime, propertyCrime, na.rm = TRUE) / n()) %>%
  arrange(desc(annualAvgCrime))
```

In this example, we we want to answer the following question: what is the annual average of the crime count per county, shown with the region it belongs to and sorted by the average count?

1. We start with `ispcrime` data
2. We use the pipe operator to feed the `ispcrime` data into `left_join()`
    * This is to add `region` column from `regions` table to our data
3. We use the pipe operator to feed the joined data into `group_by()`
    * We group the data by values of the `region` and `county` column.
4. We use the pipe operator to feed the grouped data into `summarise()`
    * We summarise data by group to get the annual average crime, a sum of `violentCrime` and `propertyCrime`, divided by total counts. Since the input is grouped, the summarising work is also done by group. 
5. We use the pipe operator to feed the grouped and summarised data into `arrange()`
    * Here we sort the data by the newly created column, `annualAvgCrime`, in a descending order
    

## More on `dplyr`

What we have seen is only a tip of an iceberg that is `dplyr`. Although the aforementioned functions are among the most commonly used in usual data manipulation and analysis tasks, the description and examples here are by no means comprehensive. Also, `dplyr` offers many other functions to facilitate data manipulation work. I recommend you to check out the following resources to learn more about `dplyr`:

* `dplyr` on [tidyverse.org](http://dplyr.tidyverse.org/)
* `dplyr` [CRAN documentation](https://cran.r-project.org/web/packages/dplyr/dplyr.pdf)
* `dplyr` [Github repository](https://github.com/tidyverse/dplyr)


***


# Tidying Up Your Data

```{r echo=FALSE, out.width="25%", out.extra='style="box-shadow: none; display: block; margin: auto;"'}
knitr::include_graphics(images[2])
```
<div style="font-size:0.5em; text-align:center; color: #777;">
Source: <a href="https://www.tidyverse.org/">tidyverse.org</a>
</div>


## Remember tidy data?
```{r echo=FALSE, out.width="100%", out.extra='style="box-shadow: none; display: block; margin: auto;"'}
knitr::include_graphics("../images/tidy-1.png")
```
<div style="font-size:0.5em; text-align:center; color: #777;">
Source: <a href="http://r4ds.had.co.nz/">R for Data Science</a>
</div>


## Key `tidyr` functions

* `gather()`
* `spread()`
* `unite()`
* `separate()`
* `separate_rows()`


## Make "wide" data longer
```{r eval=FALSE}
gather(tbl, key = "key", value = "value", ..., na.rm = FALSE, ...)
```


## Make "long" data wider
```{r eval=FALSE}
spread(tbl, key, value, fill = NA, ...)
```


### Example 
```{r}

```



## Unite multiple columns into one
```{r eval=FALSE}
unite(tbl, col, ..., sep = "_", remove = TRUE)
```


## Split a column into many
```{r eval=FALSE}
separate(tbl, col, into, sep = "[^[:alnum:]]+", remove = TRUE, ...)
```


### Example 
```{r}

```


## Split a row into many
```{r eval=FALSE}
separate_rows(tbl, ..., sep = "[^[:alnum:]]+", ...)
```


### Example 
```{r}

```


## More on `tidyr`

As in the earlier `dplyr` case, what we have seen is only part of what `tidyr` offers. I recommend you to check out the following resources to learn more about `tidyr`

* `tidyr` on [tidyverse.org](http://tidyr.tidyverse.org/)
* `tidyr` [CRAN documentation](https://cran.r-project.org/web/packages/tidyr/tidyr.pdf)
* `tidyr` [Github repository](https://github.com/tidyverse/tidyr)


***


# References
<ul>
  <li>Grolemund, G. & Wickham, H. (2017). <a href="http://r4ds.had.co.nz/"><span style="font-style:italic">R for Data Science</span></a>.</li>
  <li>RStudio. (2017). <a href="https://www.rstudio.com/resources/cheatsheets/">"Data Import Cheat Sheet"</a>.</li>
  <li>RStudio. (2017). <a href="https://www.rstudio.com/resources/cheatsheets/">"Data Transformation Cheat Sheet"</a>.</li>
  <li>Tidyverse. (n.d.). <a href="http://dplyr.tidyverse.org/"><span style="font-style:italic">dplyr.tidyverse.org</span></a>.</li>
  <li>Tidyverse. (n.d.). <a href="http://tidyr.tidyverse.org/"><span style="font-style:italic">tidyr.tidyverse.org</span></a>.</li>
  <li>Tidyverse. (n.d.). <a href="http://www.tidyverse.org/"><span style="font-style:italic">tidyverse.org</span></a>.</li>
</ul>